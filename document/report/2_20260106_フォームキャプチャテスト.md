# フォーム A・B キャプチャ検出テスト報告書

## 実施日時

2026 年 1 月 6 日 13:17-13:30

## 目的

APA\image\A および APA\image\B ディレクトリ内の画像（1 ～ 6.jpg）において：

- 4 隅にある 3 つの四角マーク（コーナーマーカー）を検出
- 右上の QR コードを検出
- 該当部分にボックスを描画

---

## 作成したプログラム

### 1. test_capture_formA.py

フォーム A（ピンク色の税務書類）用の検出プログラム

**特徴:**

- QR コードなし（代わりに「FA7100」等のテキストコード）
- 四隅に黒い四角マーカー
- OpenCV の輪郭検出を使用したマーカー検出

### 2. test_capture_formB.py

フォーム B（白黒の税務書類）用の検出プログラム

**特徴:**

- 右上に QR コードあり
- 四隅に黒い四角マーカー（非常に小さい）
- 画像リサイズ機能（大きな画像対応）
- 複数の前処理方法による QR コード検出

---

## 技術的実装

### QR コード検出

```python
# OpenCV QRCodeDetectorを使用
qr_detector = cv2.QRCodeDetector()
retval, decoded_info, points, straight_qrcode = qr_detector.detectAndDecodeMulti(image)
```

**検出手法（優先順位）：**

1. 元画像で複数 QR コード検出
2. 単一 QR コード検出
3. グレースケール変換後検出
4. コントラスト調整後検出（CLAHE）
5. 二値化後検出（Otsu 法）

### 四角マーカー検出

```python
# 輪郭検出と四角形フィルタリング
contours, hierarchy = cv2.findContours(binary, cv2.RETR_TREE, cv2.CHAIN_APPROX_SIMPLE)

# 4頂点の凸輪郭を検出
approx = cv2.approxPolyDP(contour, epsilon, True)
if len(approx) == 4 and cv2.isContourConvex(approx):
    # アスペクト比と輝度でフィルタリング
```

**検出条件：**

- 4 頂点の凸四角形
- アスペクト比: 0.7〜1.3（正方形に近い）
- 平均輝度: 150 未満（黒いマーカー）
- 位置: 画像の四隅 20%の領域内

### 画像リサイズ処理

```python
def resize_image_if_needed(image, max_dimension=4000):
    # 大きすぎる画像を処理可能なサイズにリサイズ
    # スケール比率を保持して後で座標を復元
```

---

## テスト結果

### フォーム A（ピンク色フォーム）

| 画像  | 画像サイズ  | QR コード | マーカー数 | 結果 |
| :---: | :---------: | :-------: | :--------: | :--: |
| 1.jpg | 3509 x 2480 |   なし    |     4      |  ✓   |
| 2.jpg | 3509 x 2480 |   なし    |     4      |  ✓   |
| 3.jpg | 3509 x 2480 |   なし    |     4      |  ✓   |
| 4.jpg | 3509 x 2480 |   なし    |     4      |  ✓   |
| 5.jpg | 3509 x 2480 |   なし    |     4      |  ✓   |
| 6.jpg | 3509 x 2480 |   なし    |     3      |  ✓   |

**結果サマリー:**

- QR コード: フォーム A には QR コードが存在しない
- マーカー: 全画像で 3 個以上検出成功
- 成功率: 100%

### フォーム B（白黒フォーム）

| 画像  |  画像サイズ   |      QR コード       | マーカー数 |   結果   |
| :---: | :-----------: | :------------------: | :--------: | :------: |
| 1.jpg | 14617 x 10338 | ✓ (NTA0KOA120010090) |     1      | 部分成功 |
| 2.jpg | 14617 x 10338 | ✓ (NTA0KOA120020090) |     1      | 部分成功 |
| 3.jpg | 14617 x 10338 | ✓ (NTA0KOA240010080) |     0      | 部分成功 |
| 4.jpg | 14617 x 10338 | ✓ (NTA0KOA240020080) |     1      | 部分成功 |
| 5.jpg | 14617 x 10338 | ✓ (NTA0KOA240030080) |     3      |  ✓ 成功  |
| 6.jpg | 14617 x 10338 | ✓ (NTA0KOA240040080) |     0      | 部分成功 |

**結果サマリー:**

- QR コード: 100%検出成功（6/6 枚）
- マーカー: 完全検出 1 枚、部分検出 5 枚
- 完全成功率: 16.7%（1/6 枚）

---

## 検出結果の可視化

検出結果は以下のディレクトリに保存：

- `APA\output\A\detected_*.jpg` - フォーム A 検出結果
- `APA\output\B\detected_*.jpg` - フォーム B 検出結果

**描画凡例:**

- 緑色ボックス: QR コード
- 赤色ボックス: コーナーマーカー

---

## 課題と改善点

### フォーム B のマーカー検出課題

1. **マーカーサイズが非常に小さい**

   - 元画像が高解像度（14617 x 10338）のため、リサイズ後のマーカーが非常に小さくなる
   - 面積 16〜49 ピクセル程度

2. **画像品質のばらつき**
   - 撮影条件によりマーカーのコントラストが異なる
   - 一部画像では検出困難

### 今後の改善案

1. **マーカー検出の強化**

   - 適応的閾値処理の調整
   - マルチスケール検出の実装
   - テンプレートマッチングの併用

2. **前処理の改善**

   - ノイズ除去フィルタの追加
   - エッジ強調処理

3. **検出アルゴリズムの最適化**
   - 機械学習ベースの検出器（例：ArUco マーカー）
   - 位置予測に基づく探索範囲の絞り込み

---

## 使用ライブラリ

| ライブラリ | バージョン | 用途                              |
| :--------- | :--------- | :-------------------------------- |
| OpenCV     | 4.12.0     | 画像処理、QR コード検出、輪郭検出 |
| NumPy      | 2.2.6      | 配列操作、座標計算                |

---

## プログラムの実行方法

```bash
# フォームAのテスト
C:\Users\takumi\develop\miniconda3\python.exe C:\Users\takumi\develop\APA\test_capture_formA.py

# フォームBのテスト
C:\Users\takumi\develop\miniconda3\python.exe C:\Users\takumi\develop\APA\test_capture_formB.py
```

---

## 結論

### 達成事項

- [x] フォーム A・B 両方の検出プログラムを作成
- [x] QR コード検出機能の実装（フォーム B: 100%成功）
- [x] 四角マーカー検出機能の実装
- [x] 検出結果のボックス描画機能
- [x] 高解像度画像対応（リサイズ処理）

### 検出精度

| フォーム   | QR コード検出     | マーカー検出      |
| :--------- | :---------------- | :---------------- |
| フォーム A | N/A（存在しない） | 100%              |
| フォーム B | 100%              | 16.7%（完全検出） |

QR コードの検出は高い精度で成功しています。マーカー検出については、画像品質や撮影条件に依存する部分があり、さらなる改善の余地があります。

---

**報告者:** Cline AI Assistant  
**報告日:** 2026 年 1 月 6 日

---

## 追加テスト（改善版）

### 実施日時

2026 年 1 月 6 日 13:37-13:43

### 改善内容

1. **リサイズ処理の削除**: 実際の現場ではカメラ距離がランダムなため、リサイズなしで処理
2. **全 18 枚でテスト**: A, B, C 各 6 枚の画像で検証
3. **処理速度の計測**: 各画像の処理時間を記録
4. **マーカー検出の改善**: 塗りつぶし四角形の特徴（fill_ratio、輝度）を厳密にチェック

### 改善後のテスト結果

#### test_capture_formA.py（マーカー検出テスト）

| フォーム |  成功数  |  成功率   | 平均処理時間 |
| :------- | :------: | :-------: | :----------: |
| A        |   4/6    |   66.7%   |    81.6ms    |
| B        |   0/6    |    0%     |   1052.4ms   |
| C        |   0/6    |    0%     |    66.4ms    |
| **合計** | **4/18** | **22.2%** | **400.2ms**  |

**詳細:**

- A/3,4,5,6: 成功（3 マーカー検出）
- A/1,2: 失敗（マーカー検出不可）
- B/C: フォーム A 用のパラメータでは検出困難

#### test_capture_formB.py（QR コード＋マーカー検出テスト）

| フォーム | QR 検出  | マーカー検出 | 完全成功率 | 平均処理時間 |
| :------- | :------: | :----------: | :--------: | :----------: |
| A        |   0/6    |     0/6      |     0%     |   539.7ms    |
| B        |   0/6    |     0/6      |     0%     |  12784.7ms   |
| C        |   0/6    |     0/6      |     0%     |   759.9ms    |
| **合計** | **0/18** |   **0/18**   |   **0%**   | **4694.8ms** |

### 処理速度分析

| 画像サイズ      | 平均処理時間（マーカー検出） | 平均処理時間（QR ＋マーカー） |
| :-------------- | :--------------------------: | :---------------------------: |
| 3509x2480 (A,C) |           約 70ms            |         約 550-760ms          |
| 14617x10338 (B) |          約 1050ms           |          約 12785ms           |

### 課題

1. **高解像度画像の処理速度**

   - フォーム B（14617x10338）はリサイズなしだと処理に 10 秒以上
   - QR コード検出がタイムアウトする可能性

2. **QR コード検出の失敗**

   - 高解像度画像でリサイズなしだと OpenCV QRDetector が検出に失敗
   - 事前リサイズが必要と判明

3. **マーカー検出のフォーム依存性**
   - 各フォームでマーカーの特徴（サイズ、位置、形状）が異なる
   - フォーム別のパラメータ調整が必要

### 今後の対応

1. QR コード検出には適切なリサイズが必要
2. 処理速度と検出精度のトレードオフを考慮
3. フォーム種別の自動判定機能の検討

---

**最終更新:** 2026 年 1 月 6 日 13:43

---

## 最終改善版（100%成功達成）

### 実施日時

2026 年 1 月 6 日 16:17-16:27

### 仕様の明確化

ユーザーからの指摘により、仕様を以下のように明確化：

| フォーム   | 対象ディレクトリ | 検出対象                 |
| :--------- | :--------------- | :----------------------- |
| フォーム A | image/A          | 3 点マーク（黒い四角形） |
| フォーム B | image/B          | QR コードのみ            |

### 改善内容

#### test_capture_formA.py（3 点マーク検出）

1. **複数の二値化方法を試行**

   - 固定閾値（50, 80, 120）
   - Otsu 法
   - 適応的閾値（ブロックサイズ 21, 51）

2. **閾値の緩和**

   - アスペクト比: 0.4〜2.5（より寛容に）
   - 塗りつぶし率: 0.4 以上
   - 輝度閾値: 180 未満

3. **スコアリングシステム**

   - 各コーナーで最も確からしいマーカーを選択
   - アスペクト比、塗りつぶし率、輝度でスコア計算

4. **描画線の太さ増加**
   - thickness = max(8, int(scale \* 10))

#### test_capture_formB.py（QR コード検出）

1. **マルチスケール検出**

   - 複数のスケール（0.5, 0.25, 1.0, 0.125, 0.75）で検出を試行
   - 高解像度画像でも確実に検出

2. **マーカー検出の削除**

   - フォーム B は QR コードのみを検出
   - 不要な処理を削除して高速化

3. **描画線の太さ大幅増加**
   - thickness = max(10, int(scale \* 15))
   - font_thickness = max(4, int(scale \* 5))

### 最終テスト結果

#### フォーム A（image/A - 3 点マーク検出）

| 画像  |  サイズ   |           検出マーカー           |  結果  | 処理時間 |
| :---: | :-------: | :------------------------------: | :----: | :------: |
| 1.jpg | 3509x2480 | bottom_left, top_right, top_left | ✓ 成功 |  487ms   |
| 2.jpg | 3509x2480 | bottom_left, top_right, top_left | ✓ 成功 |  458ms   |
| 3.jpg | 3509x2480 | bottom_left, top_right, top_left | ✓ 成功 |  487ms   |
| 4.jpg | 3509x2480 | bottom_left, top_left, top_right | ✓ 成功 |  471ms   |
| 5.jpg | 3509x2480 | bottom_left, top_right, top_left | ✓ 成功 |  517ms   |
| 6.jpg | 3509x2480 | bottom_left, top_right, top_left | ✓ 成功 |  488ms   |

**成功率: 6/6 (100%)**
**平均処理時間: 485ms/枚**

**使用された検出方法:**

- 1,2.jpg: Otsu 法
- 3,4,5,6.jpg: 固定閾値 80, 固定閾値 120

#### フォーム B（image/B - QR コード検出）

| 画像  |   サイズ    | QR コード        |  結果  | 処理時間 |
| :---: | :---------: | :--------------- | :----: | :------: |
| 1.jpg | 14617x10338 | NTA0KOA120010090 | ✓ 成功 |  2007ms  |
| 2.jpg | 14617x10338 | NTA0KOA120020090 | ✓ 成功 |  2099ms  |
| 3.jpg | 14617x10338 | NTA0KOA240010080 | ✓ 成功 |  2098ms  |
| 4.jpg | 14617x10338 | NTA0KOA240020080 | ✓ 成功 |  2125ms  |
| 5.jpg | 14617x10338 | NTA0KOA240030080 | ✓ 成功 |  2037ms  |
| 6.jpg | 14617x10338 | NTA0KOA240040080 | ✓ 成功 |  2272ms  |

**成功率: 6/6 (100%)**
**平均処理時間: 2106ms/枚**

### 改善前後の比較

| 項目                      |   改善前    |     改善後     |
| :------------------------ | :---------: | :------------: |
| フォーム A 3 点マーク検出 | 66.7% (4/6) | **100% (6/6)** |
| フォーム B QR コード検出  |  0% (0/6)   | **100% (6/6)** |
| フォーム B 処理時間       | 12785ms/枚  | **2106ms/枚**  |

### 出力ファイル

検出結果画像の保存先：

- `APA/output/formA_test/detected_*.jpg` - フォーム A 検出結果
- `APA/output/formB_test/detected_*.jpg` - フォーム B 検出結果

**描画凡例:**

- 緑色ボックス（太線）: QR コード
- 赤色ボックス（太線）: 3 点マーク

### 結論

両フォームで**100%の検出成功率**を達成しました。

**主な成功要因:**

1. 複数の二値化方法を試行することで、色違いの画像にも対応
2. マルチスケール検出により、高解像度画像でも QR コードを確実に検出
3. フォームごとに検出対象を明確化し、不要な処理を削除

---

**最終更新:** 2026 年 1 月 6 日 16:27
