# paper_pipeline_v5.py 改善レポート（フォーム B 探索フロー変更・robust 救済削除）

## 実施日時

2026 年 1 月 10 日

## 目的

`APA/paper_pipeline_v5.py` のフォーム B 探索（QR コード探索）について、

- **fine で何も見つからないときの救済処置**（0/90/180/270 の robust QR。さらに robust 側が前処理バリエーション＋マルチスケールで WeChat 推論を多重に叩く）

を削除し、探索フローを次の仕様へ変更する。

1. **coarse**: `0/45/90/.../315` の **8 方向**で粗探索し、上位 2 角度を選ぶ
   - この時点で **QR コードを 1 回も発見できなかったら「フォーム B でない」と判断**
2. **fine**: coarse 上位角度の近傍（±50 度）だけ、回転角リスト（`angles`）内で細かく探索

## 変更点（概要）

### 1) robust 救済（0/90/180/270）を削除

`decide_form_by_rotations()` 内に存在していた以下の救済分岐を削除。

- fine で A/B が 1 つも検出できなかった場合に、
  `0/90/180/270` で `score_formB()`（= WeChat robust マルチスケール or OpenCV robust）を試す
- `bestB_fast is None` の場合に、同様の rescue で B を拾う

結果として、**robust 救済による多重推論は一切発生しない**設計になった。

### 2) フォーム B 探索の打ち切り（coarse で QR が 0 回なら B 探索しない）

`coarse_results` の中で `B_fast.ok` が 1 回も True にならなければ

- `has_qr_in_coarse = False`
- fine の評価 `_eval()` は `enable_formB=False` で実行され、**B_fast を実行しない**

これにより、

- **「coarse で QR が出ない = フォーム B ではない」**

が実装上も担保される。

### 3) ただし「B 確定のための robust 再検証」は維持

フォーム B 候補（`bestB_fast`）が得られた場合は、従来通り

- `bestB_fast` の角度とその近傍（±rotation_step）

のみで `score_formB()` により robust 再検証してフォーム B の角度を確定する。

これは救済ではなく「確定（precision 向上）」のための最小限処理であり、
探索範囲は限定される。

## 実行確認

ユーザー環境で以下コマンドを実行し、フォーム B（2 枚 ×degrade 1）で完走することを確認。

```bash
.venv/bin/python paper_pipeline_v5.py --src-forms B --limit 2 --degrade-n 1 --log-level INFO --console-log-level INFO
```

確認できた結果（抜粋）:

- `B_1_deg00`: `stage=done`, `pred_form=B`, `template_ok=TRUE`
- `B_2_deg00`: `stage=done`, `pred_form=B`, `template_ok=TRUE`

出力ディレクトリ例:

- `APA/output_pipeline/run_20260110_103304/`

## 変更ファイル

- `APA/paper_pipeline_v5.py`

## 補足（期待される効果と注意）

### 効果

- fine 失敗時に「0/90/180/270 を robust で救済」する処理が消えるため、
  **最悪時のフォーム判定ステージ（decide_s）が短くなる**

### 注意

- 救済処置を削除したため、従来は救えていたケースが `form_unknown (no_detection)` になる可能性がある
- 精度を戻したい場合は「救済処置を復活」ではなく、
  - `fine_window_deg` を広げる
  - `rotation_step` を細かくする
    など **coarse/fine 側の探索設計を見直す**方針が推奨
