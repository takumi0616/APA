# paper_pipeline_v5.py 改善レポート（フォーム B 探索フロー変更・robust 救済削除）

## 実施日時

2026 年 1 月 10 日

## 目的

`APA/paper_pipeline_v5.py` のフォーム B 探索（QR コード探索）について、

- **fine で何も見つからないときの救済処置**（0/90/180/270 の robust QR。さらに robust 側が前処理バリエーション＋マルチスケールで WeChat 推論を多重に叩く）

を削除し、探索フローを次の仕様へ変更する。

1. **coarse**: `0/45/90/.../315` の **8 方向**で粗探索し、上位 2 角度を選ぶ
   - この時点で **QR コードを 1 回も発見できなかったら「フォーム B でない」と判断**
2. **fine**: coarse 上位角度の近傍（±50 度）だけ、回転角リスト（`angles`）内で細かく探索

## 変更点（概要）

### 1) robust 救済（0/90/180/270）を削除

`decide_form_by_rotations()` 内に存在していた以下の救済分岐を削除。

- fine で A/B が 1 つも検出できなかった場合に、
  `0/90/180/270` で `score_formB()`（= WeChat robust マルチスケール or OpenCV robust）を試す
- `bestB_fast is None` の場合に、同様の rescue で B を拾う

結果として、**robust 救済による多重推論は一切発生しない**設計になった。

### 2) フォーム B 探索の打ち切り（coarse で QR が 0 回なら B 探索しない）

`coarse_results` の中で `B_fast.ok` が 1 回も True にならなければ

- `has_qr_in_coarse = False`
- fine の評価 `_eval()` は `enable_formB=False` で実行され、**B_fast を実行しない**

これにより、

- **「coarse で QR が出ない = フォーム B ではない」**

が実装上も担保される。

### 3) ただし「B 確定のための robust 再検証」は維持

フォーム B 候補（`bestB_fast`）が得られた場合は、従来通り

- `bestB_fast` の角度とその近傍（±rotation_step）

のみで `score_formB()` により robust 再検証してフォーム B の角度を確定する。

これは救済ではなく「確定（precision 向上）」のための最小限処理であり、
探索範囲は限定される。

## 実行確認

ユーザー環境で以下コマンドを実行し、フォーム B（2 枚 ×degrade 1）で完走することを確認。

```bash
.venv/bin/python paper_pipeline_v5.py --src-forms B --limit 2 --degrade-n 1 --log-level INFO --console-log-level INFO
```

確認できた結果（抜粋）:

- `B_1_deg00`: `stage=done`, `pred_form=B`, `template_ok=TRUE`
- `B_2_deg00`: `stage=done`, `pred_form=B`, `template_ok=TRUE`

出力ディレクトリ例:

- `APA/output_pipeline/run_20260110_103304/`

## 変更ファイル

- `APA/paper_pipeline_v5.py`

## 補足（期待される効果と注意）

### 効果

- fine 失敗時に「0/90/180/270 を robust で救済」する処理が消えるため、
  **最悪時のフォーム判定ステージ（decide_s）が短くなる**

### 注意

- 救済処置を削除したため、従来は救えていたケースが `form_unknown (no_detection)` になる可能性がある
- 精度を戻したい場合は「救済処置を復活」ではなく、
  - `fine_window_deg` を広げる
  - `rotation_step` を細かくする
    など **coarse/fine 側の探索設計を見直す**方針が推奨

## 改善効果の比較（ログ比較）

改善前/改善後のログを比較して、今回の変更（フォーム B 探索フロー変更＋ robust 救済削除）の効果を定量・定性でまとめる。

- 改善後: `output_pipeline/run_20260110_103809/run.log`
- 改善前: `output_pipeline/run_20260109_234823/run.log`

### 1) 精度（KPI）への影響

結論として、**今回の変更による精度劣化はログ上は確認できない**。

| 指標                   |         改善前 |         改善後 | 差分 |
| ---------------------- | -------------: | -------------: | ---: |
| total cases            |            180 |            180 |   ±0 |
| ok_expected (user_KPI) |    173 (96.1%) |    173 (96.1%) |   ±0 |
| ok_warp                |    113 (62.8%) |    113 (62.8%) |   ±0 |
| A form accuracy        |  54/60 (90.0%) |  54/60 (90.0%) |   ±0 |
| B form accuracy        |  59/60 (98.3%) |  59/60 (98.3%) |   ±0 |
| C reject_success       | 60/60 (100.0%) | 60/60 (100.0%) |   ±0 |

### 2) 全体処理時間の改善

全体として **約 33% の高速化**が確認できる。

| 指標                      |    改善前 |    改善後 |      差分 |     改善率 |
| ------------------------- | --------: | --------: | --------: | ---------: |
| run_elapsed_total_seconds | 1824.657s | 1222.808s | -601.849s | **-33.0%** |
| avg_elapsed_per_case      |   10.137s |    6.793s |   -3.344s | **-33.0%** |
| per-case median           |    8.308s |    6.244s |   -2.064s |     -24.8% |

### 3) どこが速くなったか（ステージ別）

最も効いているのは **decide ステージ**（フォーム判定＝回転探索＋ QR 探索）で、
ここが支配的に短縮されている。

| stage time totals (s) |      改善前 |     改善後 |        差分 |     改善率 |
| --------------------- | ----------: | ---------: | ----------: | ---------: |
| degrade_s             |      102.84 |     143.54 |      +40.70 |     +39.6% |
| docaligner_s          |       32.78 |      46.24 |      +13.46 |     +41.1% |
| rectify_s             |        0.69 |       1.08 |       +0.39 |     +56.5% |
| **decide_s**          | **1429.85** | **646.11** | **-783.74** | **-54.8%** |
| match_s               |      178.56 |     267.93 |      +89.37 |     +50.0% |
| warp_s                |        5.14 |       7.84 |       +2.70 |     +52.5% |

また、平均値でも decide の短縮が顕著。

| stage time mean per case (s) |    改善前 |    改善後 |       差分 |     改善率 |
| ---------------------------- | --------: | --------: | ---------: | ---------: |
| degrade_s                    |     0.571 |     0.797 |     +0.226 |     +39.6% |
| docaligner_s                 |     0.182 |     0.257 |     +0.075 |     +41.1% |
| rectify_s                    |     0.004 |     0.006 |     +0.002 |     +56.5% |
| **decide_s**                 | **7.944** | **3.589** | **-4.355** | **-54.8%** |
| match_s                      |     0.992 |     1.488 |     +0.496 |     +50.0% |
| warp_s                       |     0.029 |     0.044 |     +0.015 |     +51.7% |

#### 注意: decide 以外が増えている点について

degrade / docaligner / match / warp が増えているが、今回の変更は主に decide 内の探索ロジックに対するものなので、
これらの増加は以下のような要因（実行環境・キャッシュ状態・CPU 負荷など）の影響が混じっている可能性が高い。

- 実行タイミングの違いによる CPU/IO 負荷差
- 初回ロード/キャッシュ状態の差

ただし、絶対値としては decide の削減幅（-783s）が圧倒的に大きいため、
他が多少増えても総時間は大きく短縮されている。

### 4) なぜ decide が短くなったか（定性考察）

今回の変更は「**QR が見えないケースに対して、robust で粘り続けない**」方向の最適化であり、
ログ上もその効果が明確に出ている。

#### (a) form_unknown(no_detection) の decide が激減

改善前は `form_unknown (no_detection)` になったケースでも、
フォーム B の robust 救済（0/90/180/270）や前処理バリエーション＋マルチスケール等の探索を行うため、
decide が長時間化しやすかった。

例:

- A の no_detection 例
  - 改善前 `A_1_deg06`: `4_decide=14.384997s`
  - 改善後 `A_1_deg06`: `4_decide=0.676291s`

この差は「救済で粘るか/早期に打ち切るか」の違いがそのまま現れている。

#### (b) C（棄却されるべき）での効果が特に大きい

改善前の C は、1 ケースあたり decide が 10〜20 秒程度になるものが多く、
全体のボトルネックになっていた（ログ上は `4_decide` がほぼ総時間を占める）。

改善後は C の `4_decide` が概ね 0.7〜5 秒程度に収まり、
**「B らしさ（QR）が無いならそこで探索をやめる」**方針が効いている。

これは本タスクで狙っていた「coarse で QR が 0 回ならフォーム B ではない」仕様と整合する。

### 5) 結論

- **精度（A/B/C の成否）は維持したまま、総処理時間を約 33% 削減**できている。
- ボトルネックだった decide（回転探索＋ QR 探索）の時間が **約 55% 減**。
- 特に「C のような QR が無い画像」「no_detection に落ちる画像」での **無駄な救済探索の削除**が効いている。
