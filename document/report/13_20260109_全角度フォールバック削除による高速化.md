# paper_pipeline_v4.py 改善レポート（全角度フォールバック削除による高速化）

## 実施日時

2026 年 1 月 9 日

## 目的

`paper_pipeline_v4.py` のフォーム判定（回転探索）で、

- **fine（細探索）で検出できなかった場合に「全角度探索（0..350 を全て再スキャン）」するフォールバック**

が実行され、処理時間が長くなる問題があったため、
この **全角度探索フォールバックを削除**して高速化する。

## 背景（問題）

`decide_form_by_rotations()` は Coarse-to-Fine（粗探索 → 細探索）になっているが、
以下の経路があると、最悪ケースで **回転スキャン回数が大幅に増える**。

1. fine の角度候補が空になった場合に `fine = list(angles)`（全角度）にしてしまう
2. fine の結果がゼロの場合に **再度 angles 全体**を ThreadPoolExecutor で回してしまう（`phase=fallback_full`）

特にフォーム B（QR）側は検出が重く、全角度フォールバックが実行されると大きく遅くなる。

## 対応内容

### 1) 仕様コメントの更新

冒頭の「パイプライン概要」内の説明を、以下の方針に修正。

- fine で何も見つからない場合は原則 Unknown（`no_detection`）
- ただし QR（フォーム B）は **0/90/180/270 のみ robust 検出**で最小限の救済を行う

### 2) `decide_form_by_rotations()` の全角度フォールバックを削除

#### (A) fine 候補が空のとき

**変更前**

- `fine = list(angles)` として全角度探索へフォールバック

**変更後**

- `_pick_nearest_angles()` を追加し、
  coarse 上位角度（base_angles）に近い角度のみを **少数**選んで試す
- それすら作れない場合は即 Unknown（`reason=no_detection`）

#### (B) fine で A/B が 1 つも検出できなかったとき

**変更前**

- angles 全体を再スキャン（full scan）

**変更後**

- angles 全体の再スキャンを廃止
- 代わりに QR（フォーム B）のみ、0/90/180/270 で robust 判定をして救済
- それでもダメなら Unknown（`reason=no_detection`、`note=full_angle_fallback_disabled`）

#### (C) 付随修正

前パッチ適用時に `bestA/bestB_fast` の更新コードが欠けてしまったため、
fine スキャンのループ内で `bestA` / `bestB_fast` を更新する処理を復元。

## 変更ファイル

- `paper_pipeline_v4.py`
  - `decide_form_by_rotations()`
    - 全角度フォールバック削除
    - fine 候補空の最小救済 `_pick_nearest_angles()` 追加
    - fine 検出ゼロ時は `no_detection` へ（QR のみ最小救済は維持）

## 動作確認

### 構文チェック

```bash
python -m py_compile paper_pipeline_v4.py
```

※ 実行環境側で `capybara` が未インストールのため、DocAligner を含むフル実行は失敗するが、
今回の変更対象（回転探索のフォールバック削除）自体は構文レベルで確認済み。

## 期待される効果

- full scan（全角度再スキャン）が発生しなくなるため、
  **フォーム判定ステージ（stage_4_form_decision_seconds）の最悪処理時間が短縮**される
- `form_unknown_reason=no_detection` が増える可能性はあるが、
  これは「時間をかけて全角度を回す」代わりに「Unknown で早期終了」する方針によるもの

## 補足（精度を落としたくなった場合）

全角度フォールバックを戻さずに精度を上げたい場合は、以下の調整が候補。

- `PIPELINE_DEFAULTS["rotation_scan"]["fine_window_deg"]` を広げる（fine 探索範囲増）
- `--rotation-step` を小さくする（例: 10 → 5）
- `_pick_nearest_angles(..., k_per_base=2)` を増やす（base 角度近傍をもう少し試す）

---

## v5 として保存した旨（ファイル名変更）

今回の改善を反映したスクリプトを、ユーザー側で **`paper_pipeline_v5.py` として保存**した。

- 基本方針: **改善内容（ロジック）はそのまま**で、ファイル名・表示名などの **v4 表記を v5 に置換**
- `paper_pipeline_v5.py` 内では `paper_pipeline_v4` / `v4` の残存は無し（機械検索で 0 件）
- `python -m py_compile paper_pipeline_v5.py` により構文チェック OK

### 注意点（置換以外の差分について）

`diff` で `paper_pipeline_v4.py` と `paper_pipeline_v5.py` を比較すると、
主目的の差分（全角度フォールバック削除）と v4→v5 置換以外に、
`PIPELINE_DEFAULTS["degrade"]["n"]` のデフォルト値が異なる（例: v4=1 / v5=10）のような差分が見える。

ただし、本レポートの「改善前/改善後ログ（run\_...）」は **合計 180 ケース（= 6 画像 × 10 改悪 × 3 フォーム）**なので、
実行時点では `--degrade-n 10` 相当で動作している（デフォルト or 引数）ことが分かる。

このため、v5 保存作業が「本当に v4→v5 置換のみ」だったかを厳密に担保したい場合は、
以下を確認すること:

- v4/v5 それぞれの `PIPELINE_DEFAULTS["degrade"]["n"]`（または実行時の `--degrade-n`）

---

## 改善前後ログの差分（run.log 比較）

対象ログ:

- 改善前: `output_pipeline/run_20260109_193024/run.log`
- 改善後: `output_pipeline/run_20260109_210550/run.log`

### 全体

- run_elapsed_total_seconds
  - 2059.041s → 1737.315s（-321.726s, **-15.63%**）
- avg_elapsed_per_case_seconds
  - 11.439s → 9.652s（-1.787s, **-15.62%**）
- per-case total time
  - mean : 11.434s → 9.647s（-1.787s, **-15.63%**）
  - median: 9.411s → 7.750s（-1.661s, **-17.65%**）

### 成功率（KPI）

※ 改善前後で成功率は維持（速度のみ改善）。

- ok_expected_behavior(user_KPI): 96.1% → 96.1%（変化なし）
- ok_warp(done_aligned_generated): 62.8% → 62.8%（変化なし）

### ステージ別（平均/1case）

ログ末尾の "stage time mean per case" より:

- decide_s（フォーム判定）: 9.317s → 7.443s（-1.874s, **-20.11%**）

今回の変更箇所（回転探索の全角度フォールバック削除）が効いて、
フォーム判定ステージが主に短縮されていることが分かる。

一方で下記は微増（ただし全体のボトルネックではない）:

- match_s: 0.946s → 0.991s（+4.76%）
- docaligner_s: 0.185s → 0.207s（+11.89%）
- warp_s: 0.027s → 0.028s（+3.70%）

---

## 補足（run.log 冒頭の表示名について）

両方の run.log 冒頭が `paper_pipeline_v4` になっているため、
これら 2 つの計測は **v4 ファイル名のまま実行したログ**として残っている。

`paper_pipeline_v5.py` を実行すると、ログ冒頭は `paper_pipeline_v5` 表記になる想定。
