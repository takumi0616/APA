# タスク（プロンプト）を行う前に必ず以下の資料を読んでください

この資料は環境がどう構築されたかを記しておりコマンド実行などの際は必ず参考にしてください
@/git_installation_guide.md
@/miniconda_installation_guide.md

タスクを行った際は、タスク成功後に、行ったことをマークダウン記法でまとめたものを@/APA\document\report の中にファイルを作成してください
ファイル名のルール：番号_年月日_行ったことを日本語.md（例：1_20260106_環境構築）
番号は@/APA\document\report の中を精査して確認してください
これまでのreportも読み込んでからタスクを行ってください
---
# プロンプト

@/APA\paper_pipeline_v2.py 
上記のプログラムに以下の改善を行ってほしいです
1. DocAligner の polygon マージン設定
固定ピクセルではなく、紙サイズに対する比率でマージンを決めると、解像度が異なる画像でも安定しやすい。


2. 進捗や失敗要因のログ強化
大量処理時にどこで止まったかを把握しやすくするため、各ステージごとの件数集計・所要時間・エラー詳細をログ/サマリに追加すると運用しやすい。
ロギング整備：print ベースではなく logging を使い、デバッグ/情報/警告をレベル別に出し分けると大規模処理で見やすくなる。


3. マーカーやQR 検出の追加前処理
照明ムラや回転によって マーカーやQR 検出が落ちる場合、輪郭抽出ベースの二値化やモルフォロジを試すオプションを追加すると検出率向上が見込める。


4. テンプレート側の前処理・キャッシュ
テンプレート画像の特徴点抽出を毎回行うと無駄が多い。テンプレ側の特徴をキャッシュしておき、対象画像のみ特徴抽出するように最適化できる。
まずグローバル特徴量の距離で上位2〜3枚に絞り込み、その後に局所特徴量で精密マッチング（RANSAC）を行うことで速度を劇的に向上させられます。


5. 回転スキャンの効率化（Coarse-to-Fineアプローチ）:
現在は全角度（360度/10度刻み＝36回）を並列処理していますが、これを「まず90度刻み（4回）で大まかな向き（縦横）を判定」→「その周辺のみ細かく探索」とすると計算量を減らせます。


6. 未知のフォームへの対応:
現在はフォームAまたはBのどちらかに無理やり分類しようとします（または判定不能）。スコアに閾値を設け、「どちらでもない（Unknown）」という判定を明確に行うロジックを追加


7. 逆ホモグラフィの安定性:
np.linalg.inv(H) は、Hが特異に近い場合に数値的に不安定になります。例外処理を入れていますが、マッチングの Inlier が極端に少ない場合は、位置合わせ結果を破棄する（信頼度低とする）


8. 日本語フォント処理の汎用化:
Windowsのパス (C:\Windows\Fonts\...) がハードコードされています。Linux/Mac環境やDocker環境で動かす場合、パスが存在せずデフォルトフォントになり、文字化け（豆腐化）する可能性があります。cv2.FONT_HERSHEY_COMPLEX などでASCIIのみにするか、OSに依存しないフォントパス解決ロジック（matplotlib.font_managerなど）の利用を検討してください。


9. 巨大な main 関数の分割:
main 関数が非常に長く、ネストも深いため、可読性が低くなっています。「1枚の画像を処理する関数 (process_one_image)」として切り出すことを推奨します。


上記の改善を順番に確実に行ってください
paper_pipeline_v2.py にはpaper_pipeline.py をそのままコピーしているので、それをちょくちょく直す形で改善を行って下さい
プログラムをすべて改善できたのちに実行して結果確認、エラーが出る場合は試行錯誤して適宜改善してください
全ての改善が無事に終了したときに、レポートの作成を行ってください