# 改訂版 memo（整理・清書）

目的：
カメラ映像から紙フォームを検出し、フォーム種別（A/B/その他）を判定したうえで
テンプレートに対して自動整列（透視変換）し、リアルタイム表示＋必要時に高品質画像を生成・保存する。

前提：
・リアルタイム処理はCPU中心（軽量優先）
・最終生成時のみ高負荷処理（必要ならGPU）を許容
・検出は「強い特徴（QR/マーカー）」を最優先し、紙輪郭検出はフォールバックで使う


--------------------------------------------
1. 入力（リアルタイム）
--------------------------------------------
- カメラからフレームを連続取得
- 事前にレンズ歪み補正（undistort）を適用（精度・見栄え向上）


--------------------------------------------
2. 検出フェーズ（軽量・頑健）
--------------------------------------------
(2-1) 紙検出（優先）
- 輪郭検出・直線検出などで「紙らしい四角形」を推定
- 紙候補を得る

(2-2)  紙検出部分からQR / マーカー検出（A or B or etc...）
- QRコードやマーカーを高速に探索
- 検出を判定

（理由）
カメラ全画面からQRやマーカーを認識するのは非常に誤検出のリスクがある
また、用紙のフォーム別検出に関する豊富なデータや先行研究モデルもないことから、背景込みから特定の模様や特徴を探すのは困難と判断
しかし、紙の検出であれば先行研究モデルが存在している


--------------------------------------------
3. フォーム種別判定（A/B/その他：ここは追加可能なようにモジュール実装を考え中）
--------------------------------------------
- フォームA：マーカー（例：正方形マーカー）で識別
- フォームB：QRコードで識別
- その他：必要に応じた識別方法（ロゴ等）

※基本方針：
「識別できた特徴点（QR四隅／マーカー角点など）を、整列用の対応点として使える形で保持する」


--------------------------------------------
4. フレーム収集（安定化・統一）
--------------------------------------------
条件：
- フォーム種別が判定でき、かつ（QR/マーカー検出 or 紙検出）できたフレームを対象にする

収集ルール：
- 紙の検出領域（マーカー周辺 / 紙領域）を中心にフレームを継続的に収集
- 毎フレームごとにフォームを判定
- 生成ボタンが押された段階で「最頻（最も多く検出された）フォーム種別」を採用して統一
- 採用フォーム以外と判定されたフレームは破棄（混在防止）


--------------------------------------------
5. 整列画像の生成（ボタン押下時：高品質）
--------------------------------------------
(5-1) 位置合わせ（Homography）
- 各フレームで Homography を推定
  - もしくは「追跡」で更新し、安定なワープを得る
- テンプレ座標系へ warp（透視変換）した画像を蓄積する

(5-2) フレーム選別（画質スコア）
- 例：ブレが少ない／露出が適正／反射が少ない等のスコアで採用フレームを絞る

(5-3) 高精度化（必要時）
- 最終生成時のみ高解像度で再ワープ
- 必要なら ECC による微調整（重い処理はここに集約）
- （必要時のみ）GPU使用可

(5-4) 合成（ノイズ・影に強い）
- 中央値（median）合成
- 外れ値除去付き平均 などで、影・ノイズ・一時的反射を低減


--------------------------------------------
6. 保存
--------------------------------------------
- 生成された整列画像を標準形式で保存
- メタ情報も保存（フォームID、スコア、検出成功率、処理時間など）
