# APA - Automatic Paper Alignment（自動紙フォーム位置合わせシステム）

## 📋 目次

1. [タスク書の解釈](#タスク書の解釈)
2. [プロジェクト概要](#プロジェクト概要)
3. [システム要件](#システム要件)
4. [提案アプローチ](#提案アプローチ)
5. [スケジュール](#スケジュール)
6. [フォルダ構成](#フォルダ構成)

---

## 📖 タスク書の解釈

### 問題の本質

このタスクは、**カメラからのリアルタイム映像を入力として、紙フォームを自動的に検出・位置合わせし、正しい形式で表示するシステム**を構築することです。

### 主要な課題

```
┌─────────────────────────────────────────────────────────────────┐
│                        入力 (Input)                             │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  カメラからのリアルタイムビデオ映像                      │   │
│  │  - 様々な角度・傾き・距離からの撮影                      │   │
│  │  - 複数種類のフォーム（A, B, C...）                      │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                       処理 (Process)                            │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  1. マーカー/QRコード/特徴点の検出                       │   │
│  │  2. 透視変換（Perspective Transform）の計算             │   │
│  │  3. 画像の補正・整列                                     │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                        出力 (Output)                            │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  - 歪み・傾き・変形のない正しい画像                      │   │
│  │  - 正しいアスペクト比と角度を維持                        │   │
│  │  - リアルタイム表示 + オプションで保存                   │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

### フォームの種類と識別方法

|  フォーム種類  | 識別方法                       | 特徴                         |
| :------------: | :----------------------------- | :--------------------------- |
| **フォーム A** | 四隅に 3 つの正方形マーカー    | ArUco マーカーのような特徴点 |
| **フォーム B** | QR コード                      | 位置と角度を特定可能         |
| **フォーム C** | その他（ロゴ、署名、透かし等） | 特徴マッチングが必要         |

### 解釈したポイント

1. **リアルタイム性が重要** - カメラからの映像を遅延なく処理・表示する必要がある
2. **マルチフォーム対応** - 複数種類のフォームに対応し、新しいテンプレートも追加可能にする
3. **UI 要件** - 左右分割画面（左：カメラ入力+オーバーレイ、右：整列済み画像）
4. **オフライン対応** - インターネット接続なしでも動作する必要がある
5. **最適化** - メモリ・CPU/GPU 効率を考慮した実装

---

## 🎯 プロジェクト概要

### 画面レイアウト設計

```
┌─────────────────────────────────────────────────────────────────┐
│                      アプリケーション画面                        │
├─────────────────────────────┬───────────────────────────────────┤
│     左側: カメラ入力         │      右側: 整列済みテンプレート    │
│  ┌───────────────────────┐  │  ┌─────────────────────────────┐ │
│  │                       │  │  │                             │ │
│  │   📷 リアルタイム      │  │  │    📄 透視変換後の画像      │ │
│  │      カメラ映像        │  │  │                             │ │
│  │                       │  │  │    - 歪み補正済み           │ │
│  │   [マーカー検出表示]   │  │  │    - 正しいアスペクト比     │ │
│  │   [バウンディングボックス]│  │  │    - 角度補正済み           │ │
│  │   [傾き矢印表示]       │  │  │                             │ │
│  │                       │  │  │                             │ │
│  └───────────────────────┘  │  └─────────────────────────────┘ │
│                             │                                   │
│  ※サイズ変更可能            │  ※ズーム/パン機能付き            │
├─────────────────────────────┴───────────────────────────────────┤
│  [保存] [設定] [フォーム種類選択]                ステータス表示  │
└─────────────────────────────────────────────────────────────────┘
```

---

## ⚙️ システム要件

### 必須要件

| 項目               | 要件                                  |
| :----------------- | :------------------------------------ |
| プログラミング言語 | Python                                |
| 成果物             | API（モジュール化された関数群）       |
| ドキュメント       | 調査報告書（実装方法の説明）          |
| デモ               | 締め切り 1 週間前まで（2026/1/23 頃） |

### 機能要件

- [x] 用紙の位置合わせ（必須）
- [x] マーカー検出とオーバーレイ表示
- [x] バウンディングボックス表示
- [x] 位置合わせ角度のリアルタイム表示
- [x] ズーム/パン機能
- [x] メモリ・CPU/GPU 最適化

### 非機能要件

- リアルタイム処理（低遅延）
- オフライン動作可能
- スケーラビリティ（新テンプレート追加容易）
- 高画質対応

---

## 💡 提案アプローチ

以下に 3 つの実装アプローチを提案します。それぞれに特徴があり、プロジェクトの優先事項に応じて選択できます。

---

### 🔷 提案 1: OpenCV 中心アプローチ（推奨：初心者向け・安定性重視）

#### 概要

OpenCV の機能を最大限活用し、シンプルで安定したシステムを構築します。

#### 技術スタック

```
┌──────────────────────────────────────────────────────────┐
│                    技術スタック                          │
├──────────────────────────────────────────────────────────┤
│  画像処理      │  OpenCV (cv2)                          │
│  マーカー検出  │  cv2.aruco (ArUcoマーカー)             │
│  QRコード検出  │  cv2.QRCodeDetector / pyzbar           │
│  GUI          │  OpenCV (cv2.imshow) / Tkinter         │
│  API化        │  FastAPI / Flask                        │
└──────────────────────────────────────────────────────────┘
```

#### 処理フロー

```
[カメラ入力] → [フレーム取得] → [前処理(グレースケール/二値化)]
                                          ↓
[マーカー/QR検出] ← [フォーム種類判定] ← [特徴点抽出]
       ↓
[透視変換行列計算] → [cv2.getPerspectiveTransform]
       ↓
[画像変換] → [cv2.warpPerspective]
       ↓
[オーバーレイ描画] → [画面表示] → [保存(オプション)]
```

#### メリット・デメリット

| メリット                | デメリット                      |
| :---------------------- | :------------------------------ |
| ✅ 学習コストが低い     | ❌ 複雑な特徴マッチングには限界 |
| ✅ ドキュメントが豊富   | ❌ GUI が簡素                   |
| ✅ オフライン対応が容易 | ❌ 深層学習モデルの統合が複雑   |
| ✅ 処理速度が速い       |                                 |

#### 実装手順

```
Week 1 (1/5-1/11):
├── 環境構築
├── OpenCV基礎調査
├── カメラ入力処理実装
└── ArUcoマーカー検出実装

Week 2 (1/12-1/18):
├── QRコード検出実装
├── 透視変換処理実装
├── フォームA/B対応
└── 基本UI実装

Week 3 (1/19-1/25):
├── フォームC対応（特徴マッチング）
├── オーバーレイ機能実装
├── ズーム/パン機能
├── デモ準備・提出 (1/23頃)
└── バグ修正

Week 4 (1/26-2/6):
├── 調査報告書作成
├── レポート提出 (1/30)
├── 最終調整
└── 最適化・テスト
```

---

### 🔶 提案 2: 深層学習ハイブリッドアプローチ（パフォーマンス重視）

#### 概要

深層学習モデルを活用して、より高精度なマーカー検出と特徴マッチングを実現します。

#### 技術スタック

```
┌──────────────────────────────────────────────────────────┐
│                    技術スタック                          │
├──────────────────────────────────────────────────────────┤
│  深層学習フレームワーク  │  PyTorch / TensorFlow        │
│  物体検出              │  YOLOv8 / Detectron2          │
│  特徴マッチング        │  SuperPoint + SuperGlue        │
│  画像処理             │  OpenCV                         │
│  GUI                  │  PyQt5 / Streamlit              │
│  API                  │  FastAPI + uvicorn              │
└──────────────────────────────────────────────────────────┘
```

#### アーキテクチャ

```
                    ┌─────────────────┐
                    │   カメラ入力    │
                    └────────┬────────┘
                             │
                    ┌────────▼────────┐
                    │   前処理モジュール│
                    │  (リサイズ/正規化)│
                    └────────┬────────┘
                             │
           ┌─────────────────┼─────────────────┐
           │                 │                 │
    ┌──────▼──────┐   ┌──────▼──────┐   ┌──────▼──────┐
    │ ArUco検出   │   │ QR検出     │   │ DL特徴抽出  │
    │ (OpenCV)    │   │ (pyzbar)   │   │ (SuperPoint)│
    └──────┬──────┘   └──────┬──────┘   └──────┬──────┘
           │                 │                 │
           └─────────────────┼─────────────────┘
                             │
                    ┌────────▼────────┐
                    │  統合検出結果   │
                    │  (Fusion Layer) │
                    └────────┬────────┘
                             │
                    ┌────────▼────────┐
                    │   透視変換計算   │
                    └────────┬────────┘
                             │
                    ┌────────▼────────┐
                    │   結果出力/表示  │
                    └─────────────────┘
```

#### メリット・デメリット

| メリット                  | デメリット                    |
| :------------------------ | :---------------------------- |
| ✅ 高精度な検出           | ❌ 学習コストが高い           |
| ✅ 複雑なフォームにも対応 | ❌ 計算リソースが必要         |
| ✅ ロバスト性が高い       | ❌ モデルのセットアップに時間 |
| ✅ 将来的な拡張性         | ❌ オフライン対応に工夫が必要 |

#### 実装手順

```
Week 1 (1/5-1/11):
├── 環境構築（CUDA, PyTorch等）
├── 深層学習モデル調査
├── 基本的なカメラ処理
└── YOLOv8 または SuperPoint セットアップ

Week 2 (1/12-1/18):
├── マーカー検出モデル訓練/Fine-tuning
├── QRコード検出統合
├── 特徴マッチングパイプライン構築
└── 透視変換処理実装

Week 3 (1/19-1/25):
├── GUI実装 (PyQt5/Streamlit)
├── リアルタイム処理最適化
├── デモ準備・提出 (1/23頃)
└── バグ修正

Week 4 (1/26-2/6):
├── 調査報告書作成
├── レポート提出 (1/30)
├── GPU最適化
└── 最終テスト
```

---

### 🔷 提案 3: モジュラーアーキテクチャアプローチ（保守性・拡張性重視）

#### 概要

プラグイン形式で各検出器を独立させ、新しいフォームタイプを容易に追加できるアーキテクチャを構築します。

#### 技術スタック

```
┌──────────────────────────────────────────────────────────┐
│                    技術スタック                          │
├──────────────────────────────────────────────────────────┤
│  コア処理        │  OpenCV + NumPy                      │
│  設計パターン    │  Strategy Pattern + Factory Pattern  │
│  設定管理        │  YAML / JSON                         │
│  GUI            │  PyQt5 (ドッキング可能なウィンドウ)    │
│  API            │  FastAPI + Pydantic                   │
│  テスト         │  pytest + coverage                    │
└──────────────────────────────────────────────────────────┘
```

#### クラス設計

```
┌─────────────────────────────────────────────────────────────────┐
│                     BaseDetector (抽象クラス)                    │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  + detect(frame) -> List[Point]                           │ │
│  │  + get_transform_matrix(points) -> Matrix                 │ │
│  │  + draw_overlay(frame, points) -> Frame                   │ │
│  └───────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
           ▲                    ▲                    ▲
           │                    │                    │
┌──────────┴──────────┐ ┌──────┴──────┐ ┌──────────┴──────────┐
│  ArucoDetector      │ │ QRDetector │ │  FeatureDetector   │
│  (フォームA用)       │ │ (フォームB用)│ │  (フォームC用)      │
└─────────────────────┘ └─────────────┘ └─────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                      DetectorFactory                            │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  + create_detector(form_type: str) -> BaseDetector        │ │
│  │  + register_detector(name, detector_class)                │ │
│  └───────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                      AlignmentPipeline                          │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  - detectors: Dict[str, BaseDetector]                     │ │
│  │  + process_frame(frame) -> AlignedResult                  │ │
│  │  + add_detector(name, detector)                           │ │
│  └───────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

#### ディレクトリ構造

```
APA/
├── README.md
├── requirements.txt
├── config/
│   ├── settings.yaml
│   └── templates/
│       ├── form_a.yaml
│       ├── form_b.yaml
│       └── form_c.yaml
├── src/
│   ├── __init__.py
│   ├── core/
│   │   ├── __init__.py
│   │   ├── pipeline.py
│   │   └── transformer.py
│   ├── detectors/
│   │   ├── __init__.py
│   │   ├── base.py
│   │   ├── aruco_detector.py
│   │   ├── qr_detector.py
│   │   └── feature_detector.py
│   ├── gui/
│   │   ├── __init__.py
│   │   ├── main_window.py
│   │   └── widgets/
│   └── api/
│       ├── __init__.py
│       └── endpoints.py
├── tests/
│   ├── test_detectors.py
│   └── test_pipeline.py
├── document/
│   └── (タスク指示PDF)
└── image/
    ├── A/
    ├── B/
    └── C/
```

#### メリット・デメリット

| メリット                  | デメリット                |
| :------------------------ | :------------------------ |
| ✅ 新フォーム追加が容易   | ❌ 初期設計に時間がかかる |
| ✅ テストがしやすい       | ❌ 過度な抽象化のリスク   |
| ✅ チーム開発に適している | ❌ シンプルな要件には過剰 |
| ✅ 保守性が高い           |                           |

#### 実装手順

```
Week 1 (1/5-1/11):
├── アーキテクチャ設計
├── 基本クラス構造実装
├── 設定ファイル形式決定
└── BaseDetector + ArucoDetector実装

Week 2 (1/12-1/18):
├── QRDetector実装
├── FeatureDetector実装
├── Pipeline統合
└── 単体テスト作成

Week 3 (1/19-1/25):
├── GUI実装
├── API実装
├── デモ準備・提出 (1/23頃)
└── 統合テスト

Week 4 (1/26-2/6):
├── 調査報告書作成
├── レポート提出 (1/30)
├── ドキュメント整備
└── 最終調整
```

---

## 📅 スケジュール

### 全体タイムライン

```
2026年1月
日  月  火  水  木  金  土
          1   2   3   4
 5   6   7   8   9  10  11  ← Week 1: 環境構築・基礎実装
12  13  14  15  16  17  18  ← Week 2: コア機能実装
19  20  21  22  23  24  25  ← Week 3: UI/デモ準備 【デモ提出: 23日頃】
26  27  28  29  30  31      ← Week 4: 報告書作成 【レポート提出: 30日】

2026年2月
日  月  火  水  木  金  土
                      1
 2   3   4   5   6          ← 最終調整・完了【期限: 6日】
```

### マイルストーン

| 日付 | マイルストーン       | 詳細                         |
| :--: | :------------------- | :--------------------------- |
| 1/11 | 基礎実装完了         | カメラ入力、マーカー検出動作 |
| 1/18 | コア機能完了         | 全フォーム対応、透視変換動作 |
| 1/23 | **デモ提出**         | 動作するデモを提出           |
| 1/30 | **レポート提出**     | 調査報告書を提出             |
| 2/6  | **プロジェクト完了** | 最終成果物提出               |

---

## 📁 フォルダ構成

### 現在の構成

```
APA/
├── README.md           ← このファイル
├── document/
│   ├── Task1_RQ_v1.pdf    ← タスク指示書 v1
│   └── Task1_RQ_v1.1.pdf  ← タスク指示書 v1.1
└── image/
    ├── A/              ← フォームAのサンプル画像 (6枚)
    │   ├── 1.jpg
    │   ├── 2.jpg
    │   └── ...
    ├── B/              ← フォームBのサンプル画像 (6枚)
    │   ├── 1.jpg
    │   └── ...
    └── C/              ← フォームCのサンプル画像 (6枚)
        ├── 1.jpg
        └── ...
```

---

## 🚀 次のステップ

1. **提案の選択**: 上記 3 つの提案から、プロジェクトの目的に最も適したアプローチを選択
2. **環境構築**: Python 環境、必要なライブラリのインストール
3. **サンプル画像の分析**: image/フォルダ内の画像を確認し、各フォームの特徴を把握
4. **プロトタイプ開発**: 選択したアプローチで基本機能を実装

---

## 📝 推奨事項

| 状況                            | 推奨アプローチ                        |
| :------------------------------ | :------------------------------------ |
| Python や画像処理の経験が少ない | **提案 1** (OpenCV 中心)              |
| 高精度が最優先、GPU 環境がある  | **提案 2** (深層学習ハイブリッド)     |
| チーム開発、長期保守を想定      | **提案 3** (モジュラーアーキテクチャ) |

---

## 📚 参考リソース

- [OpenCV 公式ドキュメント](https://docs.opencv.org/)
- [OpenCV ArUco マーカー検出](https://docs.opencv.org/4.x/d5/dae/tutorial_aruco_detection.html)
- [pyzbar - QR コード検出](https://github.com/NaturalHistoryMuseum/pyzbar)
- [FastAPI 公式ドキュメント](https://fastapi.tiangolo.com/)

---

_最終更新: 2026 年 1 月 6 日_
